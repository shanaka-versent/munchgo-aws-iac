# External Secrets - MunchGo Database Credentials
# @author Shanaka Jayasundera - shanakaj@gmail.com
#
# Pulls RDS PostgreSQL credentials from AWS Secrets Manager into K8s Secrets.
# Each MunchGo service gets its own database credentials secret.
# The Secrets Manager secrets are created by Terraform (rds module).
#
# Secret naming convention in Secrets Manager:
#   <name_prefix>-munchgo-<db_name>-db-<random>
#
# The ExternalSecret refreshes every 1 hour (configurable).

---
# Master database credentials (for admin operations, Flyway initial setup)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: munchgo-db-master
  namespace: munchgo
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: munchgo-db-master
    creationPolicy: Owner
  dataFrom:
    - extract:
        # This will be updated with the actual Secrets Manager secret name
        # after terraform apply. Use: terraform output rds_master_secret_arn
        key: kong-gw-poc-munchgo-rds-20260214125937647200000010

---
# Auth Service database credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: munchgo-auth-db
  namespace: munchgo
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: munchgo-auth-db-credentials
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: kong-gw-poc-munchgo-auth-db-2026021412593746010000000c

---
# Consumer Service database credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: munchgo-consumers-db
  namespace: munchgo
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: munchgo-consumers-db-credentials
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: kong-gw-poc-munchgo-consumers-db-2026021412593756150000000e

---
# Restaurant Service database credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: munchgo-restaurants-db
  namespace: munchgo
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: munchgo-restaurants-db-credentials
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: kong-gw-poc-munchgo-restaurants-db-20260214125936673100000001

---
# Courier Service database credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: munchgo-couriers-db
  namespace: munchgo
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: munchgo-couriers-db-credentials
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: kong-gw-poc-munchgo-couriers-db-20260214125936673500000007

---
# Order Service database credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: munchgo-orders-db
  namespace: munchgo
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: munchgo-orders-db-credentials
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: kong-gw-poc-munchgo-orders-db-20260214125936673400000005

---
# Saga Orchestrator database credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: munchgo-sagas-db
  namespace: munchgo
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: munchgo-sagas-db-credentials
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: kong-gw-poc-munchgo-sagas-db-20260214125936673300000003
