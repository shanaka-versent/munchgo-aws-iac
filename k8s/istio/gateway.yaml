# Kong Cloud Gateway on EKS - Kubernetes Gateway API - Gateway Resource
# @author Shanaka Jayasundera - shanakaj@gmail.com
#
# This creates the Istio ingress gateway with an INTERNAL NLB.
# Kong Cloud Gateway reaches this single NLB via AWS Transit Gateway.
#
# Traffic flow:
#   Client --> Kong Cloud GW (external) --[Transit GW]--> Internal NLB --> Istio Gateway --> Pods
#
# IMPORTANT: This uses Gateway API (gateway.networking.k8s.io), NOT Ingress
# IMPORTANT: Replaces per-service internal NLBs with a single Istio Gateway NLB
#
# TLS CONFIGURATION:
# Kong Cloud Gateway connects to this Internal NLB over HTTP or HTTPS.
# The Gateway supports both HTTP (port 80) and HTTPS (port 443).
# Istio Ambient mesh provides automatic mTLS between all pods.

---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: kong-cloud-gw-gateway
  namespace: istio-ingress
spec:
  # Use Istio's Gateway API implementation
  gatewayClassName: istio

  # Infrastructure configuration for the auto-created Service
  # Uses AWS Load Balancer Controller annotations for INTERNAL NLB
  infrastructure:
    labels:
      role: system
    annotations:
      # AWS Load Balancer Controller - INTERNAL NLB (not internet-facing)
      service.beta.kubernetes.io/aws-load-balancer-type: "external"
      service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "ip"
      # CRITICAL: Internal scheme - accessible only via Transit Gateway from Kong
      service.beta.kubernetes.io/aws-load-balancer-scheme: "internal"
      # Health check configuration
      service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: "TCP"
      service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: "traffic-port"
      service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval: "10"
      service.beta.kubernetes.io/aws-load-balancer-healthcheck-unhealthy-threshold: "2"

  listeners:
    # HTTP Listener (port 80) - Kong Cloud Gateway connects here
    - name: http
      port: 80
      protocol: HTTP
      allowedRoutes:
        namespaces:
          from: All

    # HTTPS Listener (port 443) - Optional end-to-end TLS
    - name: https
      port: 443
      protocol: HTTPS
      tls:
        mode: Terminate
        certificateRefs:
          - kind: Secret
            name: istio-gateway-tls
            namespace: istio-ingress
      allowedRoutes:
        namespaces:
          from: All
